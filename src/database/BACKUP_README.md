# Резервное копирование базы данных

## Описание

Скрипт для создания и восстановления резервных копий базы данных PostgreSQL.

## Требования

- PostgreSQL установлен и доступен в PATH
- Утилиты `pg_dump` и `pg_restore` должны быть доступны
- Правильно настроены переменные окружения в `.env` файле

## Использование

### Создание резервной копии

**Стандартная команда (custom формат, сжатый):**
```bash
npm run backup
```

**Создание резервной копии в SQL формате (текстовый):**
```bash
npm run backup create plain
```

**Создание резервной копии в TAR формате:**
```bash
npm run backup create tar
```

### Просмотр списка резервных копий

```bash
npm run backup list
```

### Восстановление из резервной копии

**Обычное восстановление:**
```bash
npm run backup restore ./backups/marina_crm_backup_2025-11-10T14-30-00.dump
```

**Восстановление с очисткой базы данных (удаление существующих объектов):**
```bash
npm run backup restore ./backups/marina_crm_backup_2025-11-10T14-30-00.dump --clean
```

## Форматы резервных копий

1. **Custom (по умолчанию)** - `.dump`
   - Сжатый формат
   - Можно восстанавливать выборочно
   - Рекомендуется для продакшена

2. **Plain** - `.sql`
   - Текстовый SQL формат
   - Можно редактировать вручную
   - Удобно для просмотра

3. **Tar** - `.tar`
   - Архивный формат
   - Можно восстанавливать выборочно

## Расположение файлов

Резервные копии сохраняются в директории `./backups/` в корне проекта.

Имя файла формируется автоматически: `marina_crm_backup_YYYY-MM-DDTHH-MM-SS.dump`

## Переменные окружения

Скрипт использует следующие переменные из `.env` файла:

- `DB_HOST` - хост базы данных (по умолчанию: localhost)
- `DB_PORT` - порт базы данных (по умолчанию: 5432)
- `DB_NAME` - имя базы данных (по умолчанию: marina_crm)
- `DB_USER` - пользователь базы данных (по умолчанию: postgres)
- `DB_PASSWORD` - пароль базы данных (по умолчанию: postgres)

## Примеры

### Создание резервной копии перед обновлением

```bash
npm run backup
```

### Восстановление после ошибки

```bash
npm run backup restore ./backups/marina_crm_backup_2025-11-10T14-30-00.dump --clean
```

### Просмотр всех резервных копий

```bash
npm run backup list
```

## Важные замечания

⚠️ **ВНИМАНИЕ**: При восстановлении с флагом `--clean` все существующие данные в базе будут удалены!

⚠️ Перед восстановлением рекомендуется создать новую резервную копию текущего состояния базы данных.

## Автоматизация

Для автоматического создания резервных копий можно настроить cron (Linux/Mac) или Task Scheduler (Windows):

**Linux/Mac (cron):**
```bash
# Создание резервной копии каждый день в 2:00 ночи
0 2 * * * cd /path/to/marina-crm && npm run backup
```

**Windows (Task Scheduler):**
- Создайте задачу, которая запускает `npm run backup` ежедневно

## Устранение неполадок

### Ошибка: "pg_dump: command not found"

Убедитесь, что PostgreSQL установлен и `pg_dump` доступен в PATH.

**Windows:**
- Добавьте путь к PostgreSQL bin в переменную PATH
- Обычно: `C:\Program Files\PostgreSQL\<version>\bin`

**Linux/Mac:**
- Установите PostgreSQL: `sudo apt-get install postgresql-client` (Ubuntu/Debian)
- Или: `brew install postgresql` (Mac)

### Ошибка: "password authentication failed"

Проверьте правильность пароля в `.env` файле.

### Ошибка: "database does not exist"

Убедитесь, что база данных существует и имя указано правильно в `.env` файле.

