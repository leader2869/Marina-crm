# Архитектура Marina CRM

## 📐 Общая структура

Система построена по модульному принципу с разделением на слои:

```
┌─────────────────────────────────────────┐
│         Presentation Layer              │
│    (API Routes / Controllers)          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Business Logic Layer            │
│    (Services / Controllers)             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Data Access Layer               │
│    (TypeORM Entities / Repositories)   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Database Layer                  │
│    (PostgreSQL)                         │
└─────────────────────────────────────────┘
```

## 🏗️ Модульная архитектура

### Модули системы

1. **Auth Module** (`src/modules/auth/`)
   - Регистрация и аутентификация
   - Управление профилем
   - JWT токены

2. **Clubs Module** (`src/modules/clubs/`)
   - CRUD операции с яхт-клубами
   - Управление причалами
   - Фильтрация и поиск

3. **Vessels Module** (`src/modules/vessels/`)
   - Управление судами
   - Регистрационные документы
   - Технические характеристики

4. **Bookings Module** (`src/modules/bookings/`)
   - Создание бронирований
   - Проверка доступности
   - Управление периодами аренды

5. **Finances Module** (`src/modules/finances/`)
   - Учет доходов
   - Учет расходов с гибкой категоризацией
   - Финансовая аналитика
   - Бюджетирование

6. **Payments Module** (`src/modules/payments/`)
   - Создание платежей
   - Управление статусами
   - Начисление пеней
   - Отслеживание просрочек

## 🔐 Система авторизации (RBAC)

### Роли пользователей

```typescript
enum UserRole {
  SUPER_ADMIN = 'super_admin',    // Полный контроль
  ADMIN = 'admin',                // Управление клубами
  CLUB_OWNER = 'club_owner',      // Владелец клуба
  VESSEL_OWNER = 'vessel_owner',  // Судовладелец
  GUEST = 'guest'                 // Гость
}
```

### Middleware авторизации

- `authenticate` - проверка JWT токена
- `authorize(...roles)` - проверка прав доступа

## 💾 Модель данных

### Основные сущности

1. **User** - Пользователи системы
2. **Club** - Яхт-клубы
3. **Berth** - Причалы
4. **Vessel** - Судна
5. **Booking** - Бронирования
6. **Income** - Доходы
7. **Expense** - Расходы
8. **ExpenseCategory** - Категории расходов
9. **Payment** - Платежи
10. **Budget** - Бюджеты

### Связи между сущностями

```
User (owner) ──→ Club
User (owner) ──→ Vessel
Club ──→ Berth
Club ──→ Booking
Berth ──→ Booking
Vessel ──→ Booking
User (vesselOwner) ──→ Booking
Club ──→ Income
Club ──→ Expense
ExpenseCategory ──→ Expense
Booking ──→ Payment
User (payer) ──→ Payment
Club ──→ Budget
```

## 🔄 Бизнес-процессы

### Процесс бронирования

1. Поиск клуба (фильтры: location, цена, доступность)
2. Выбор периода аренды
3. Проверка доступности причала
4. Создание бронирования (статус: PENDING)
5. Создание платежа
6. Оплата
7. Подтверждение бронирования (статус: CONFIRMED)
8. Начало аренды (статус: ACTIVE)
9. Завершение (статус: COMPLETED)

### Процесс учета расходов

1. Планирование бюджета
2. Ввод расхода
3. Утверждение (для крупных сумм)
4. Оплата
5. Учет в системе
6. Анализ и корректировка

### Процесс контроля просрочек

1. Ежедневная проверка платежей
2. Автоматическое обновление статуса на OVERDUE
3. Начисление пеней
4. Отправка уведомлений
5. Блокировка услуг (при необходимости)

## 📊 Финансовая аналитика

### Ключевые метрики

- **Чистая прибыль** = Доходы - Расходы
- **Рентабельность** = (Чистая прибыль / Доходы) × 100%
- **MARINA Ratio** = (Расходы / Доходы) × 100%
- **Cash Flow** = Движение денежных средств

### Отчеты

- Ежедневные сводки
- Ежемесячные P&L отчеты
- Квартальный и годовой анализ
- Сравнение с предыдущими периодами
- Структура расходов по категориям

## 🛡️ Безопасность

### Меры безопасности

1. **Аутентификация**: JWT токены
2. **Авторизация**: RBAC (Role-Based Access Control)
3. **Валидация**: Проверка входных данных
4. **Обработка ошибок**: Централизованный error handler
5. **Аудит**: Логирование действий (в разработке)

### Контроль расходов

- Лимиты самостоятельного утверждения
- Многоуровневое согласование
- Полный аудиторский след

## 🚀 API Endpoints

### Аутентификация
- `POST /api/auth/register` - Регистрация
- `POST /api/auth/login` - Вход
- `GET /api/auth/profile` - Профиль пользователя

### Яхт-клубы
- `GET /api/clubs` - Список клубов (с фильтрами)
- `GET /api/clubs/:id` - Детали клуба
- `POST /api/clubs` - Создание клуба
- `PUT /api/clubs/:id` - Обновление клуба
- `DELETE /api/clubs/:id` - Удаление клуба

### Судна
- `GET /api/vessels` - Список судов
- `GET /api/vessels/:id` - Детали судна
- `POST /api/vessels` - Создание судна
- `PUT /api/vessels/:id` - Обновление судна
- `DELETE /api/vessels/:id` - Удаление судна

### Бронирования
- `GET /api/bookings` - Список бронирований
- `GET /api/bookings/:id` - Детали бронирования
- `POST /api/bookings` - Создание бронирования
- `PUT /api/bookings/:id` - Обновление бронирования
- `DELETE /api/bookings/:id` - Отмена бронирования

### Финансы
- `GET /api/finances/incomes` - Список доходов
- `POST /api/finances/incomes` - Создание дохода
- `GET /api/finances/expenses` - Список расходов
- `POST /api/finances/expenses` - Создание расхода
- `POST /api/finances/expenses/:id/approve` - Утверждение расхода
- `GET /api/finances/expense-categories` - Категории расходов
- `POST /api/finances/expense-categories` - Создание категории
- `GET /api/finances/analytics` - Финансовая аналитика
- `GET /api/finances/budgets` - Список бюджетов
- `POST /api/finances/budgets` - Создание бюджета

### Платежи
- `GET /api/payments` - Список платежей
- `GET /api/payments/overdue` - Просроченные платежи
- `GET /api/payments/:id` - Детали платежа
- `POST /api/payments` - Создание платежа
- `PUT /api/payments/:id/status` - Обновление статуса

## 📦 Зависимости

### Основные
- **express** - Web framework
- **typeorm** - ORM для работы с БД
- **pg** - PostgreSQL драйвер
- **jsonwebtoken** - JWT токены
- **bcryptjs** - Хеширование паролей
- **date-fns** - Работа с датами

### Разработка
- **typescript** - TypeScript компилятор
- **ts-node** - Запуск TypeScript
- **nodemon** - Автоперезагрузка
- **concurrently** - Параллельный запуск

## 🔧 Конфигурация

Все настройки хранятся в `.env` файле:
- Параметры БД
- JWT секреты
- Email настройки
- Платежные шлюзы
- Пути для загрузки файлов

## 📝 Следующие шаги

1. ✅ Базовая структура проекта
2. ✅ Модели данных
3. ✅ API endpoints
4. ⏳ Frontend приложение
5. ⏳ Email/SMS уведомления
6. ⏳ Интеграция платежных шлюзов
7. ⏳ Мобильное приложение
8. ⏳ Расширенная аналитика
9. ⏳ Экспорт отчетов



